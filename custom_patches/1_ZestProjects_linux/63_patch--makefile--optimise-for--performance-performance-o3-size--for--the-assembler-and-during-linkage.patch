From a9b72174bd3ac67a0f296dfcd0a0ab9b776c3874 Mon Sep 17 00:00:00 2001
From: Diab Neiroukh <lazerl0rd@thezest.dev>
Date: Tue, 26 Jan 2021 01:18:15 +0000
Subject: [PATCH] Makefile: Optimise for {performance,performance_o3,size} for
 the assembler and during linkage.

Signed-off-by: Diab Neiroukh <lazerl0rd@thezest.dev>
---
 Makefile | 23 ++++++++++++++++++++---
 1 file changed, 20 insertions(+), 3 deletions(-)

diff --git a/Makefile b/Makefile
index 570bfe6a31cd..ac5513a7020d 100644
--- a/Makefile
+++ b/Makefile
@@ -733,11 +733,28 @@ KBUILD_CFLAGS	+= $(call cc-disable-warning, format-overflow)
 KBUILD_CFLAGS	+= $(call cc-disable-warning, address-of-packed-member)
 
 ifdef CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE
-KBUILD_CFLAGS += -O2
+KBUILD_AFLAGS	+= -O2
+KBUILD_CFLAGS	+= -O2
+KBUILD_LDFLAGS	+= -O2
+ifdef CONFIG_CC_IS_CLANG
+ifdef CONFIG_LTO
+KBUILD_LDFLAGS	+= --lto-O2
+endif
+endif
 else ifdef CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE_O3
-KBUILD_CFLAGS += -O3
+KBUILD_AFLAGS	+= -O3
+KBUILD_CFLAGS	+= -O3
+KBUILD_LDFLAGS	+= -O3
+ifdef CONFIG_CC_IS_CLANG
+ifdef CONFIG_LTO
+# It isn't possible to currently boot a kernel with --lto-O3.
+KBUILD_LDFLAGS	+= --lto-O2
+endif
+endif
 else ifdef CONFIG_CC_OPTIMIZE_FOR_SIZE
-KBUILD_CFLAGS += -Os
+KBUILD_AFLAGS	+= -Os
+KBUILD_CFLAGS	+= -Os
+KBUILD_LDFLAGS	+= -Os
 endif
 
 # Tell gcc to never replace conditional load with a non-conditional one
