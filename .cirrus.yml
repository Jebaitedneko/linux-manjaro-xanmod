main_task:
    only_if: $CIRRUS_CHANGE_TITLE =~ "cirrus[:] r[0-9]+" && $CIRRUS_BRANCH == 'master'
    timeout_in: 120m
    container:
        image: archlinux/base
        cpu: 8
        memory: 32G
    ivybridge_script:
        - pacman -Syu --needed --noconfirm base-devel
        - sed -i '/E_ROOT/d' /usr/bin/makepkg
        - sed -i "s/PKGEXT='.pkg.tar.xz'/PKGEXT='.pkg.tar.zst'/" /etc/makepkg.conf
        - echo 'COMPRESSZST+=(--threads=0)' >> /etc/makepkg.conf
        - env cibuild=y makepkg -sCcf --skipinteg --skipchecksums --skippgpcheck
    artifacts:
        path: "*.pkg.tar.zst"
